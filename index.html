<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-title" content="Gelatokartan" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/onsenui/css/onsen-css-components.min.css"
    />
    <script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>
    <script
      src="https://maps.googleapis.com/maps/api/js?callback=initMap&libraries=&v=weekly"
      async
    ></script>
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
    <title>Gelatokartan</title>
    <style>
      #map {
        height: 50%;
        width: 100%;
      }
      html,
      body {
        height: 100%;
        display: flex;
        flex-direction: column;
        margin: 0;
        padding: 0;
      }

      footer {
        transform: rotate(180deg);
      }

      .control-panel {
        height: 75px;
        display: flex;
        flex-flow: row wrap;
        justify-content: center;
        margin-bottom: 5px;
      }

      .controls {
        font-size: 28px;
        font-weight: 300;
        margin-top: 15px;
        text-align: center;
        user-select: none;
        padding: 2px;
      }

      .controls button {
        border-radius: 25px;
        border: none;
        cursor: pointer;
        height: 6vh;
        color: white;
        width: 6vh;
      }

      .controls button:active {
        box-shadow: none;
      }

      .controls.zoom-control {
        height: auto;
      }
      .controls.zoom-control button {
        font: 0.85em Arial;
        margin: 0px;
        padding: 0;
        background-color: #568259;
      }

      .controls.pan-control {
        height: auto;
      }

      .controls.pan-control button {
        font: 0.85em Arial;
        margin: 0px;
        background-color: #f6c2a4;
      }

      .controls .buttonHere {
        font: Arial;
        margin: 0px;
        padding: 0;
        background-color: #DE5571;
        font-size: 10px;
      }
    </style>
  </head>
  <body>
    <ons-navigator id="navigator" page="home.html"></ons-navigator>

    <script>
      const openPage = (page) => {
        document.getElementById('navigator').pushPage(page.id);
        console.log(document.getElementById("navigator").topPage)
      }
      </script>

    <template id="home.html">
      <ons-page id="home">

        <ons-toolbar id="home-toolbar" style="background-color: #f6c2a4">
          <div id="gelatokartan-heading" class="center" style="color: white">GELATOKARTAN</div>
          <div class="right">
            <ons-toolbar-button onclick="openPage(profile)">
              <ons-icon icon="md-account" style="color: white;"></ons-icon>
            </ons-toolbar-button>
          </div>
        </ons-toolbar>

          <div id="map" style="border-radius: 10px"></div>

          <div class="control-panel">
            <div class="controls zoom-control">
              <button class="zoom-control-in" title="Zoom In">+</ons-button>
              <button class="zoom-control-out" title="Zoom Out"
                >−</button
              >
            </div>
            <div class="controls pan-control">
              <button class="pan-control-west" title="Pan West"
                >&larr;</ons-button
              >
              <button class="pan-control-north" title="Pan North">
                &uarr;
              </button>
              <button class="pan-control-south" title="Pan South">
                &darr;
              </button>
              <button class="pan-control-east" title="Pan East"
                >&rarr;</ons-button
              >
            </div>
            <div class="controls geo-control">
              <button class="buttonHere">Min <br/>plats</button>
            </div>
          </div>

          <svg id="Lager_1" data-name="Lager 1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 340 200"><defs><style>.cls-1{fill:none;}.cls-2{fill:#f6c2a4;}.cls-3{fill:url(#Nytt_mönster);}.topp{ font: xx-large sans-serif; fill:white;font-weight:bolder;}</style><pattern id="Nytt_mönster" data-name="Nytt mönster" width="340" height="200" patternUnits="userSpaceOnUse" viewBox="0 0 340 200"><rect class="cls-1" width="340" height="200"/><rect class="cls-2" width="340" height="146.68"/><path class="cls-2" d="M.35,146.68c10.11-1.28,21.33,38.28,36,38.26,16,0,19.34-37.86,33.67-38.26s20.23,34.44,35.24,34.37,20.42-34.44,35.24-34.37c14,.07,18.54,30.66,33.68,32,13.79,1.25,19.18-32.6,31.32-32,11.82.55,19.88,32.71,33.86,31.54,15.43-1.29,12-30.21,28.61-31.46,16.13-1.22,23.9,29.6,41.49,29.7,12.18.07,20.08-29.49,30.17-29.7"/></pattern></defs><rect class="cls-3" width="340" height="200"/>
            <text x="50%" y="50%" class="topp" dominant-baseline="middle" text-anchor="middle">TOPPVAL</text>
          </svg>

          <div>
            <ons-card class="mjuk">
              <h2 class="card__title" style="color:#DE5571; font: Helvetica; font-weight:bolder">Mjuk Mjuk</h2>
              <div class="card__content">Text</div>
            </ons-card>
          </div>
          <div>
            <ons-card class="sno">
                <h2 class="card__title" style="color:#DE5571; font: Helvetica; font-weight:bolder">SNÖ</h2>
                <div class="card__content">Text</div>
              </ons-card>
            </div>
            <div>
              <ons-card class="scarfo">
                  <h2 class="card__title" style="color:#DE5571; font: Helvetica; font-weight:bolder">Scarfo</h2>
                  <div class="card__content">Text</div>
                </ons-page>
              </div>
        </div>
        <footer>
          <svg id="Lager_1" data-name="Lager 1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 340 200"><defs><style>.cls-1{fill:none;}.cls-2{fill:#f6c2a4;}.cls-3{fill:url(#Nytt_mönster);}</style><pattern id="Nytt_mönster" data-name="Nytt mönster" width="340" height="200" patternUnits="userSpaceOnUse" viewBox="0 0 340 200"><rect class="cls-1" width="340" height="200"/><rect class="cls-2" width="340" height="146.68"/><path class="cls-2" d="M.35,146.68c10.11-1.28,21.33,38.28,36,38.26,16,0,19.34-37.86,33.67-38.26s20.23,34.44,35.24,34.37,20.42-34.44,35.24-34.37c14,.07,18.54,30.66,33.68,32,13.79,1.25,19.18-32.6,31.32-32,11.82.55,19.88,32.71,33.86,31.54,15.43-1.29,12-30.21,28.61-31.46,16.13-1.22,23.9,29.6,41.49,29.7,12.18.07,20.08-29.49,30.17-29.7"/></pattern></defs><rect class="cls-3" width="340" height="200"/></svg>
        </footer>
       </ons-page>
   </template>

   <template id="profile">
     <ons-page id="profile">
      <ons-toolbar id="home-toolbar" style="background-color: #f6c2a4">
        <div class="center" style="color: white">PROFIL</div>
        <div class="left">
          <ons-back-button></ons-back-button>
        </div>
      </ons-toolbar>

      <div id="sign-in"style="text-align: center;">
        <ons-button id="sign-in" style="margin-top: 20px;" onclick="signIn()">
          Sign-in with Google
        </ons-button>
      </div>

      <div hidden id="loggedin">
        <div style="display:flex; justify-content: center;">
          <div id="user-pic" style="height:100px; width: 100px; border-radius: 50%; margin-top: 20px;"></div>
        </div>
        <div>
          <ons-card id="profileinfo">
            <h2 id="user-name" class="card__title" style="color:#DE5571;"></h2>
          </ons-card>
        </div>
        <div style="text-align: center;">
          <ons-button id="sign-out" style="margin-top: 20px;" onclick="signOut()">
            Sign-out
          </ons-button>
        </div>
      </div>

      <footer>
        <svg id="Lager_1" data-name="Lager 1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 340 200"><defs><style>.cls-1{fill:none;}.cls-2{fill:#f6c2a4;}.cls-3{fill:url(#Nytt_mönster);}</style><pattern id="Nytt_mönster" data-name="Nytt mönster" width="340" height="200" patternUnits="userSpaceOnUse" viewBox="0 0 340 200"><rect class="cls-1" width="340" height="200"/><rect class="cls-2" width="340" height="146.68"/><path class="cls-2" d="M.35,146.68c10.11-1.28,21.33,38.28,36,38.26,16,0,19.34-37.86,33.67-38.26s20.23,34.44,35.24,34.37,20.42-34.44,35.24-34.37c14,.07,18.54,30.66,33.68,32,13.79,1.25,19.18-32.6,31.32-32,11.82.55,19.88,32.71,33.86,31.54,15.43-1.29,12-30.21,28.61-31.46,16.13-1.22,23.9,29.6,41.49,29.7,12.18.07,20.08-29.49,30.17-29.7"/></pattern></defs><rect class="cls-3" width="340" height="200"/></svg>
      </footer>

     </ons-page>
   </template>

   <template id="infoview">
     <ons-page id="infoview">
      <ons-toolbar id="home-toolbar" style="background-color: #f6c2a4">
        <div id="gelato-bar-name" class="center" style="color: white">Namn</div>
        <div class="left">
          <ons-back-button></ons-back-button>
        </div>
      </ons-toolbar>
      <div style="padding: 20px;">
      <ons-card>
        <div class="description" style="color:#DE5571; font: Helvetica;">Beskrivning</div>
      </ons-card>
      <ons-card>
        <div class="adress" style="color:#DE5571; font: Helvetica;">Adress</div>
      </ons-card>
      <ons-card>
        <div class="hours" style="color:#DE5571; font: Helvetica;">Öppettider</div>
      </ons-card>
      <p style="font-size: x-large; font-weight: bolder; color:#DE5571;">
        OMDÖMEN
      </p>
      <ons-card>
        <div class="comments">Inga kommentarer än</div>
      </ons-card>
      <div style="text-align: center; margin-top: 30px;">
        <p>
      <ons-input id="review-input" placeholder="Lämna ett omdöme!" float></ons-input>
    </p>
    <p style="margin-top: 30px;">
      <ons-button onclick=saveMessage()>Kommentera</ons-button>
    </p>
    </div>
    </div>

      <script>
        ons.getScriptPage().onInit = function() {
          console.log('This is a lifecycle hook!', this);
        };
      </script>

      <footer>
        <svg id="Lager_1" data-name="Lager 1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 340 200"><defs><style>.cls-1{fill:none;}.cls-2{fill:#f6c2a4;}.cls-3{fill:url(#Nytt_mönster);}</style><pattern id="Nytt_mönster" data-name="Nytt mönster" width="340" height="200" patternUnits="userSpaceOnUse" viewBox="0 0 340 200"><rect class="cls-1" width="340" height="200"/><rect class="cls-2" width="340" height="146.68"/><path class="cls-2" d="M.35,146.68c10.11-1.28,21.33,38.28,36,38.26,16,0,19.34-37.86,33.67-38.26s20.23,34.44,35.24,34.37,20.42-34.44,35.24-34.37c14,.07,18.54,30.66,33.68,32,13.79,1.25,19.18-32.6,31.32-32,11.82.55,19.88,32.71,33.86,31.54,15.43-1.29,12-30.21,28.61-31.46,16.13-1.22,23.9,29.6,41.49,29.7,12.18.07,20.08-29.49,30.17-29.7"/></pattern></defs><rect class="cls-3" width="340" height="200"/></svg>
      </footer>
     </ons-page>
   </template>
   <script src="./index.js"></script>
   <!-- The core Firebase JS SDK is always required and must be listed first -->
   <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-app.js"></script>
   <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-firestore.js"></script>
   <script src="https://www.gstatic.com/firebasejs/8.6.2/firebase-auth.js"></script>
  <!-- <script src="/https://www.gstatic.com/firebase/init.js"></script> -->

   <script>

    firebase.initializeApp({
      apiKey: "AIzaSyD6Z4UjiaNIW0HU9y_oJRgw1aMmFE_82kY",
      authDomain: "gelatokartan.firebaseapp.com",
      projectId: "gelatokartan"
    });

    let db = firebase.firestore();


    async function getData() {

    let gelatobarer = [];
    await db
      .collection("gelatobarer")
      .get()
      .then((item) =>
        item.forEach((doc) => {
          const bar = { ...doc.data(), address: doc.id };
          gelatobarer.push(bar);
        }),
      );
      gelatobarer.forEach(bar => {
        var pos = {
							lat: parseFloat(bar.latitud),
							lng: parseFloat(bar.longitud)
							};
        var marker = new google.maps.Marker({
          map,
          draggable: false,
          position: pos,
          title: bar.namn
        });
        var infoWindow = new google.maps.InfoWindow({
          content: `${bar.namn} Klicka för info`
        });
        marker.addListener('click', function() {
          infoWindow.open(map, marker);
          marker.addListener("click", function() {
          currentBar = bar;
          storedBar = currentBar;
          console.log(storedBar)
          openPage(infoview);
          document.addEventListener('init', function(event) {
          console.log('This is a lifecycle event!', event.target);

          var page = event.target;
          if (page.matches('#infoview')) {
            page.querySelector('ons-toolbar .center').innerHTML = storedBar.namn;
            page.querySelector('ons-card .description').innerHTML = storedBar.beskrivning;
            page.querySelector('ons-card .adress').innerHTML = storedBar.adress;
            page.querySelector('ons-card .hours').innerHTML = storedBar.öppettider;

            page.getElementByClassName("save-message").onclick()
            };})
    })})})}

    getData();

    function saveMessage() {
      // Add a new message entry to the database.
      var messageText = document.getElementById('review-input').value;
      return firebase.firestore().collection('reviews').add({
        name: "testnamn",
        text: messageText,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).catch(function(error) {
        console.error('Error writing new message to database', error);
      });
    }

        // Signs-in.
    function signIn() {
      // Sign into Firebase using popup auth & Google as the identity provider.
      var provider = new firebase.auth.GoogleAuthProvider();
      firebase.auth().signInWithPopup(provider);
      //initFirebaseAuth()
    }

    // Signs-out.
    function signOut() {
      // Sign out of Firebase.
      firebase.auth().signOut();
    }

    // Initiate Firebase Auth.
    function initFirebaseAuth() {
      // Listen to auth state changes.
      firebase.auth().onAuthStateChanged(authStateObserver);
    }

    // Returns the signed-in user's profile pic URL.
    function getProfilePicUrl() {
      return (
        firebase.auth().currentUser.photoURL || "/images/profile_placeholder.png"
      );
    }

    function addSizeToGoogleProfilePic(url) {
      if (url.indexOf('googleusercontent.com') !== -1 && url.indexOf('?') === -1) {
        return url + '?sz=150';
      }
      return url;
    }

  // Displays a Message in the UI.
  function displayMessage(id, timestamp, name, text) {
    const newDiv = document.createElement("div");
    const newContent = document.createTextNode(text);
    newDiv.appendChild(newContent);}

    // Returns the signed-in user's display name.
    function getUserName() {
      console.log(firebase.auth().currentUser.displayName);
      return firebase.auth().currentUser.displayName;
    }

    // Returns true if a user is signed-in.
    function isUserSignedIn() {
      return !!firebase.auth().currentUser;
    }

    function authStateObserver() {
      user = isUserSignedIn()
      console.log(user)
      currentPage = document.getElementById("navigator").getCurrentPage()
      console.log(currentPage)
      if (document.getElementById("navigator").topPage.matches("profile")) {
        if(user) {
          var profilePicUrl = getProfilePicUrl();
          var userName = getUserName();

          // Show user's profile and sign-out button.
          document.getElementById("loggedin").removeAttribute("hidden")

          // Hide sign-in button.
          document.getElementById("sign-in").setAttribute('hidden', 'true');

          // Set the user's profile pic and name.
          document.getElementById("user-name").textContent = userName
          document.getElementById("user-pic").style.backgroundImage = 'url(' + addSizeToGoogleProfilePic(profilePicUrl) + ')'
          console.log(document.getElementById("user-pic"))

        } else { // User is signed out!
        // Hide user's profile and sign-out button.
        document.getElementById("loggedin").setAttribute('hidden', 'true');

        // Show sign-in button.
        document.getElementById("sign-in").removeAttribute('hidden');
      }
    }}

    // Loads chat messages history and listens for upcoming ones.
    function loadMessages() {
        // Create the query to load the last 12 messages and listen for new ones.
          var query = firebase.firestore()
                      .collection('reviews')
                      .orderBy('timestamp', 'desc')

          console.log(query)

        // Start listening to the query.
          query.onSnapshot(function(snapshot) {
            snapshot.docChanges().forEach(function(change) {
            if (change.type === 'removed') {
              deleteMessage(change.doc.id);
            } else {
              var message = change.doc.data();
              displayMessage(change.doc.id, message.timestamp, message.namn,
                          message.text);
            }
          });
        });
        }

        loadMessages()

        // Delete a Message from the UI.
        function deleteMessage(id) {
          var div = document.getElementById(id);
          // If an element for that message exists we delete it.
          if (div) {
            div.parentNode.removeChild(div);
          }
        }

      // Displays a Message in the UI.
      function displayMessage(id, timestamp, name, text) {
        const newDiv = document.createElement("div");
        const newContent = document.createTextNode(text);
        newDiv.appendChild(newContent);
        document.addEventListener('init', function(event) {
          console.log('This is a lifecycle event!', event.target);

          var page = event.target;
          if (page.matches('#infoview')) {
            var messageContainer = document.querySelector('ons-card .comments');
            messageContainer.appendChild(newDiv);
            };})
      }

      initFirebaseAuth()

    var messageListElement = document.getElementById('messages');
    var messageFormElement = document.getElementById('message-form');
    var messageInputElement = document.getElementById('message');
    var submitButtonElement = document.getElementById('submit');
    var imageButtonElement = document.getElementById('submitImage');
    var imageFormElement = document.getElementById('image-form');
    var mediaCaptureElement = document.getElementById('mediaCapture');
    var userPicElement = document.getElementById('user-pic');
    var userNameElement = document.getElementById('user-name');
    var signInButtonElement = document.getElementById('sign-in');
    var signOutButtonElement = document.getElementById('sign-out');
    //var signInSnackbarElement = document.getElementById('must-signin-snackbar');

  </script>
  </body>
</html>
